# Prometheus Configuration for MSPByte Pipeline
#
# This configuration file enables Prometheus to scrape metrics from the
# MSPByte Pipeline HTTP server.
#
# Usage:
#   1. Install Prometheus: https://prometheus.io/download/
#   2. Copy this file to your Prometheus directory
#   3. Start Prometheus: prometheus --config.file=prometheus.yml
#   4. Access Prometheus UI: http://localhost:9090

global:
  scrape_interval: 15s # Scrape metrics every 15 seconds
  evaluation_interval: 15s # Evaluate rules every 15 seconds

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    monitor: 'mspbyte-pipeline'
    environment: 'production' # Change to 'staging' or 'development' as needed

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "alerts.yml"
  # - "recording_rules.yml"

# Scrape configuration
scrape_configs:
  # MSPByte Pipeline metrics
  - job_name: 'mspbyte-pipeline'

    # Scrape interval (overrides global)
    scrape_interval: 15s
    scrape_timeout: 10s

    # Metrics path (default is /metrics)
    metrics_path: '/metrics'

    # Scheme (http or https)
    scheme: http

    # Static targets
    static_configs:
      - targets: ['localhost:3001']
        labels:
          service: 'pipeline'
          component: 'backend'

    # Optional: Metric relabeling
    # metric_relabel_configs:
    #   - source_labels: [__name__]
    #     regex: 'mspbyte_.*'
    #     action: keep

  # Health check endpoint (optional)
  - job_name: 'mspbyte-health'
    scrape_interval: 30s
    metrics_path: '/health'
    scheme: http
    static_configs:
      - targets: ['localhost:3001']
        labels:
          service: 'pipeline'
          check: 'health'

# Example alert rules (create alerts.yml and uncomment rule_files above)
# groups:
#   - name: mspbyte_alerts
#     interval: 30s
#     rules:
#       # High error rate
#       - alert: HighPipelineErrorRate
#         expr: rate(mspbyte_pipeline_executions_total{status="error"}[5m]) > 0.01
#         for: 5m
#         labels:
#           severity: warning
#         annotations:
#           summary: "High pipeline error rate detected"
#           description: "Pipeline error rate is {{ $value | humanizePercentage }} (threshold: 1%)"
#
#       # Slow pipeline
#       - alert: SlowPipelineExecution
#         expr: mspbyte_pipeline_duration_ms > 60000
#         for: 10m
#         labels:
#           severity: warning
#         annotations:
#           summary: "Pipeline execution is slow"
#           description: "Average pipeline duration is {{ $value }}ms (threshold: 60000ms)"
#
#       # Too many slow queries
#       - alert: HighSlowQueryRate
#         expr: (mspbyte_slow_queries_total / mspbyte_queries_total) > 0.01
#         for: 10m
#         labels:
#           severity: info
#         annotations:
#           summary: "High slow query rate"
#           description: "{{ $value | humanizePercentage }} of queries are slow (threshold: 1%)"
#
#       # Service down
#       - alert: PipelineDown
#         expr: up{job="mspbyte-pipeline"} == 0
#         for: 2m
#         labels:
#           severity: critical
#         annotations:
#           summary: "MSPByte Pipeline is down"
#           description: "Pipeline has been down for more than 2 minutes"
